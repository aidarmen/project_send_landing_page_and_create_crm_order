{% extends "base.html" %}
{% block title %}Панель управления{% endblock %}
{% block content %}
<div class="row g-3">
  <div class="col"><div class="card p-3"><b>Пользователи</b><div>{{ users }}</div></div></div>
  <div class="col"><div class="card p-3"><b>Предложения</b><div>{{ offers }}</div></div></div>
  <div class="col"><div class="card p-3"><b>Ссылки</b><div>{{ links }}</div></div></div>
</div>
<div class="mt-4">
  <h4>Статусы</h4>
  <div id="statusPie" style="height:320px" class="border rounded bg-white"></div>
</div>
<div class="mt-4">
  <h4>Недавние загрузки</h4>
  <div id="uploadsBar" style="height:260px" class="border rounded bg-white mb-3"></div>
  <table class="table table-sm">
    <thead>
      <tr>
        <th>ID</th>
        <th>Файл</th>
        <th>Предложение</th>
        <th>Загружено</th>
        <th>Истекает</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for u in uploads %}
      <tr>
        <td>{{ u["id"] }}</td>
        <td>{{ u["filename"] }}</td>
        <td>{{ u["offer_title"] }}</td>
        <td>{{ u["uploaded_at"]|fmt_dt }}</td>
        <td>{{ u["expires_at"]|fmt_dt }}</td>
        <td>
          <a class="btn btn-sm btn-outline-primary"
             href="{{ url_for('admin.upload_detail', upload_id=u['id']) }}">
            Открыть
          </a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
<div class="mt-4">
  <h4>Согласия по дням (30д)</h4>
  <div id="agreeTrend" style="height:300px" class="border rounded bg-white"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script>
  // Status pie
  const pieEl = document.getElementById('statusPie');
  if (pieEl) {
    const pie = echarts.init(pieEl);
    const pieData = [
      {% for s in stats %}
      {name: '{{ s["status"] or "UNKNOWN" }}', value: {{ s["n"] or 0 }}},
      {% endfor %}
    ];
    pie.setOption({
      tooltip: { trigger: 'item' },
      legend: { top: 'bottom' },
      series: [{ type: 'pie', radius: ['35%','70%'], data: pieData }]
    });
  }

  // Uploads bar
  const upEl = document.getElementById('uploadsBar');
  if (upEl) {
    const up = echarts.init(upEl);
    const labels = {{ upload_labels|tojson }};
    const totals = {{ upload_totals|tojson }};
    up.setOption({
      grid: { left: 40, right: 10, top: 20, bottom: 30 },
      tooltip: { trigger: 'axis' },
      xAxis: { type: 'category', data: labels },
      yAxis: { type: 'value' },
      series: [{ name: 'links', type: 'bar', data: totals }]
    });
  }

  // Agreements trend
  const trEl = document.getElementById('agreeTrend');
  if (trEl) {
    const tr = echarts.init(trEl);
    const x = {{ agree_dates|tojson }};
    const y = {{ agree_counts|tojson }};
    tr.setOption({
      grid: { left: 40, right: 10, top: 20, bottom: 30 },
      tooltip: { trigger: 'axis' },
      xAxis: { type: 'category', data: x },
      yAxis: { type: 'value' },
      series: [{ type: 'line', areaStyle: {}, data: y }]
    });
  }
</script>
{% endblock %}
