{% extends "base.html" %}
{% block title %}Предложение{% endblock %}
{% block content %}
<h3>{{ 'Редактировать предложение' if row else 'Новое предложение' }}</h3>

<form method="post" action="{{ url_for('admin.offer_save') }}" class="row g-3" id="offerForm">
  {% if row %}<input type="hidden" name="id" value="{{ row['id'] }}">{% endif %}

  <div class="col-md-6">
    <label class="form-label">Название</label>
    <input class="form-control" name="title" required value="{{ row and row['title'] }}">
  </div>

  <div class="col-md-3">
    <label class="form-label">Тип пакета (ярлык)</label>
    <select class="form-select" name="bundle" required>
      {% for val, label in [('internet','интернет'), ('fms','fms'), ('tv','тв'), ('bundle','пакет')] %}
        <option value="{{ val }}" {% if row and row['bundle']==val %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-3">
    <label class="form-label">Цена</label>
    <input class="form-control" name="price" type="number" step="1" value="{{ row and row['price'] }}">
  </div>

  <div class="col-md-3">
    <label class="form-label">Валюта</label>
    <input class="form-control" name="currency" value="{{ ((row and row['currency']) or '₸')|replace('KZT', '₸') }}">
  </div>

  <div class="col-12"><hr></div>

  <div class="col-md-6">
    <label class="form-label">Бейджи (через запятую)</label>
    <input class="form-control" name="badge_text" value="{{ badge_text }}">
  </div>

  <div class="col-12"><strong>Включить услуги в это предложение:</strong></div>

  <!-- ИНТЕРНЕТ -->
  {% set internet = comp.get('internet', {}) %}
  <div class="col-12 form-check">
    <input class="form-check-input svc-toggle" type="checkbox" id="has_internet" name="has_internet" {% if internet %}checked{% endif %}>
    <label class="form-check-label" for="has_internet">Интернет</label>
  </div>
  <div class="svc internet row g-2 {% if not internet %}d-none{% endif %}">
    <div class="col-md-6">
      <label class="form-label">Заголовок</label>
      <input class="form-control" name="internet_title" value="{{ internet.get('title','Домашний интернет') }}">
    </div>
    <div class="col-md-3">
      <label class="form-label">Макс. скорость (Мбит/с)</label>
      <input class="form-control" name="internet_max_speed_mbps" type="number" value="{{ internet.get('max_speed_mbps','') }}">
    </div>
  </div>

  <!-- ТВ -->
  {% set tv = comp.get('tv', {}) %}
  <div class="col-12 form-check">
    <input class="form-check-input svc-toggle" type="checkbox" id="has_tv" name="has_tv" {% if tv %}checked{% endif %}>
    <label class="form-check-label" for="has_tv">ТВ</label>
  </div>
  <div class="svc tv row g-2 {% if not tv %}d-none{% endif %}">
    <div class="col-md-6">
      <label class="form-label">Заголовок</label>
      <input class="form-control" name="tv_title" value="{{ tv.get('title','Телевидение, фильмы и сериалы') }}">
    </div>
    <div class="col-md-3">
      <label class="form-label">Каналы</label>
      <input class="form-control" name="tv_channels" type="number" value="{{ tv.get('channels','') }}">
    </div>
    <div class="col-md-12">
      <label class="form-label">Онлайн-кинотеатры (через запятую)</label>
      <input class="form-control" name="tv_ott" value="{{ (tv.get('ott') or [])|join(', ') }}">
    </div>
  </div>

  <!-- МОБИЛЬНАЯ СВЯЗЬ -->
  {% set mobile = comp.get('mobile', {}) %}
  <div class="col-12 form-check">
    <input class="form-check-input svc-toggle" type="checkbox" id="has_mobile" name="has_mobile" {% if mobile %}checked{% endif %}>
    <label class="form-check-label" for="has_mobile">Мобильная связь</label>
  </div>
  <div class="svc mobile row g-2 {% if not mobile %}d-none{% endif %}">
    <div class="col-md-6">
      <label class="form-label">Заголовок</label>
      <input class="form-control" name="mobile_title" value="{{ mobile.get('title','Мобильная связь') }}">
    </div>
    <div class="col-md-2">
      <label class="form-label">SIM-карт</label>
      <input class="form-control" name="mobile_sims" type="number" value="{{ mobile.get('sims','') }}">
    </div>
    <div class="col-md-2">
      <label class="form-label">Интернет (ГБ)</label>
      <input class="form-control" name="mobile_data_gb" type="number" value="{{ mobile.get('data_gb','') }}">
    </div>
    <div class="col-md-2">
      <label class="form-label">После лимита (Кбит/с)</label>
      <input class="form-control" name="mobile_after_cap_kbps" type="number" value="{{ mobile.get('after_cap_kbps','') }}">
    </div>
    <div class="col-md-2">
      <label class="form-label">Минут внутри сети</label>
      <input class="form-control" name="mobile_onnet_minutes" type="number" value="{{ mobile.get('onnet_minutes','') }}">
    </div>
    <div class="col-md-2">
      <label class="form-label">Минут на другие/городские</label>
      <input class="form-control" name="mobile_offnet_minutes" type="number" value="{{ mobile.get('offnet_minutes','') }}">
    </div>
    <div class="col-md-2">
      <label class="form-label">SMS</label>
      <input class="form-control" name="mobile_sms" type="number" value="{{ mobile.get('sms','') }}">
    </div>
    <div class="col-md-3 form-check mt-4">
      <input class="form-check-input" type="checkbox" name="mobile_tv_plus_included" {% if mobile.get('tv_plus_included') %}checked{% endif %}>
      <label class="form-check-label">TV+ включён</label>
    </div>
  </div>

  <!-- ДОМАШНИЙ ТЕЛЕФОН -->
  {% set phone = comp.get('home_phone', {}) %}
  <div class="col-12 form-check">
    <input class="form-check-input svc-toggle" type="checkbox" id="has_home_phone" name="has_home_phone" {% if phone %}checked{% endif %}>
    <label class="form-check-label" for="has_home_phone">Домашний телефон</label>
  </div>
  <div class="svc home_phone row g-2 {% if not phone %}d-none{% endif %}">
    <div class="col-md-6">
      <label class="form-label">Заголовок</label>
      <input class="form-control" name="phone_title" value="{{ phone.get('title','Домашний телефон') }}">
    </div>
    <div class="col-md-3">
      <label class="form-label">Минут внутри сети</label>
      <input class="form-control" name="phone_onnet_minutes" type="number" value="{{ phone.get('onnet_minutes','') }}">
    </div>
    <div class="col-md-3">
      <label class="form-label">Минут на другие/городские</label>
      <input class="form-control" name="phone_offnet_minutes" type="number" value="{{ phone.get('offnet_minutes','') }}">
    </div>
  </div>

  <!-- SIM ДЛЯ УСТРОЙСТВ -->
  {% set iot = comp.get('sim_devices', {}) %}
  <div class="col-12 form-check">
    <input class="form-check-input svc-toggle" type="checkbox" id="has_sim_devices" name="has_sim_devices" {% if iot %}checked{% endif %}>
    <label class="form-check-label" for="has_sim_devices">SIM для устройств</label>
  </div>
  <div class="svc sim_devices row g-2 {% if not iot %}d-none{% endif %}">
    <div class="col-md-6">
      <label class="form-label">Заголовок</label>
      <input class="form-control" name="iot_title" value="{{ iot.get('title','SIM для устройств') }}">
    </div>
    <div class="col-md-2">
      <label class="form-label">SIM-карт</label>
      <input class="form-control" name="iot_sims" type="number" value="{{ iot.get('sims','') }}">
    </div>
    <div class="col-md-2">
      <label class="form-label">Интернет (ГБ)</label>
      <input class="form-control" name="iot_data_gb" type="number" value="{{ iot.get('data_gb','') }}">
    </div>
    <div class="col-md-3">
      <label class="form-label">После лимита (Кбит/с)</label>
      <input class="form-control" name="iot_after_cap_kbps" type="number" value="{{ iot.get('after_cap_kbps','') }}">
    </div>
  </div>

  <div class="col-12"><hr></div>

  <!-- Конфигурация элементов заказа (CUST_ORDER_ITEMS) -->
  <div class="col-12"><strong>Конфигурация элементов заказа (CUST_ORDER_ITEMS)</strong></div>
  <div class="col-md-3 mb-3">
    <label class="form-label">PRODUCT_OFFER_ID</label>
    <input class="form-control" type="number" name="product_offer_id" value="{{ row and row['product_offer_id'] }}">
  </div>
  <div class="col-12 mb-3">
    <button type="button" class="btn btn-sm btn-success" id="add-order-item-btn">Добавить элемент заказа</button>
  </div>
  <div id="cust-order-items-container" class="col-12">
    {% if cust_order_items %}
      {% for item in cust_order_items %}
        {% set item_idx = loop.index0 %}
        <div class="card mb-3 order-item" data-item-index="{{ item_idx }}">
          <div class="card-header d-flex justify-content-between align-items-center">
            <strong>Элемент заказа #{{ loop.index }}</strong>
            <button type="button" class="btn btn-sm btn-danger remove-order-item">Удалить</button>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-3">
                <label class="form-label">EXTERNAL_ID</label>
                <input class="form-control" name="cust_order_items[{{ item_idx }}][external_id]" value="{{ item.get('external_id', '') }}">
              </div>
              <div class="col-md-2">
                <label class="form-label">ORDER_NUM</label>
                <input class="form-control" type="number" name="cust_order_items[{{ item_idx }}][order_num]" value="{{ item.get('order_num', '') }}">
              </div>
              <div class="col-md-2">
                <label class="form-label">PO_COMPONENT_ID</label>
                <input class="form-control" type="number" name="cust_order_items[{{ item_idx }}][po_component_id]" value="{{ item.get('po_component_id', '') }}">
              </div>
              <div class="col-md-2">
                <label class="form-label">PRODUCT_OFFER_STRUCT_ID</label>
                <input class="form-control" type="number" name="cust_order_items[{{ item_idx }}][product_offer_struct_id]" value="{{ item.get('product_offer_struct_id', '') }}">
              </div>
              <div class="col-md-2">
                <label class="form-label">SERVICE_COUNT</label>
                <input class="form-control" type="number" name="cust_order_items[{{ item_idx }}][service_count]" value="{{ item.get('service_count', '') }}">
              </div>
            </div>
            <div class="mt-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <strong>PO_STRUCT_ELEMENTS</strong>
                <button type="button" class="btn btn-sm btn-secondary add-element-btn">Добавить элемент</button>
              </div>
              <div class="elements-container">
                {% if item.get('po_struct_elements') %}
                  {% for element in item.get('po_struct_elements', []) %}
                    {% set elem_idx = loop.index0 %}
                    <div class="row g-2 mb-2 element-row" data-element-index="{{ elem_idx }}">
                      <div class="col-md-4">
                        <label class="form-label">PO_STRUCT_ELEMENT_ID</label>
                        <input class="form-control" type="number" name="cust_order_items[{{ item_idx }}][po_struct_elements][{{ elem_idx }}][po_struct_element_id]" value="{{ element.get('po_struct_element_id', '') }}">
                      </div>
                      <div class="col-md-3">
                        <label class="form-label">SERVICE_COUNT</label>
                        <input class="form-control" type="number" name="cust_order_items[{{ item_idx }}][po_struct_elements][{{ elem_idx }}][service_count]" value="{{ element.get('service_count', '') }}">
                      </div>
                      <div class="col-md-3 d-flex align-items-end">
                        <button type="button" class="btn btn-sm btn-danger remove-element-btn">Удалить элемент</button>
                      </div>
                    </div>
                  {% endfor %}
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    {% endif %}
  </div>

  <div class="col-12">
    <button class="btn btn-primary">Сохранить</button>
  </div>
</form>

{% if debug_messages %}
<div class="col-12 mt-3">
  <div class="card">
    <div class="card-header bg-info text-white">
      <strong>Debug Information</strong>
    </div>
    <div class="card-body">
      <ul class="mb-0">
        {% for msg in debug_messages %}
          <li class="{% if 'WARNING' in msg or 'Skipped' in msg %}text-warning{% else %}text-info{% endif %}">{{ msg }}</li>
        {% endfor %}
      </ul>
    </div>
  </div>
</div>
{% endif %}

<script>
  // показать/скрыть секции по чекбоксам
  document.querySelectorAll(".svc-toggle").forEach(cb => {
    cb.addEventListener("change", () => {
      const cls = cb.id.replace("has_", "");
      const block = document.querySelector(".svc."+cls);
      if (block) block.classList.toggle("d-none", !cb.checked);
    });
  });

  // CUST_ORDER_ITEMS dynamic management
  const container = document.getElementById('cust-order-items-container');
  if (!container) {
    console.error('Container #cust-order-items-container not found');
  }
  let itemCounter = container ? container.querySelectorAll('.order-item').length : 0;

  function reindexItems() {
    const items = container.querySelectorAll('.order-item');
    items.forEach((item, idx) => {
      item.setAttribute('data-item-index', idx);
      item.querySelector('.card-header strong').textContent = `Элемент заказа #${idx + 1}`;
      
      // Update all input names
      item.querySelectorAll('input[name*="cust_order_items["]').forEach(input => {
        const name = input.getAttribute('name');
        const newName = name.replace(/cust_order_items\[\d+\]/, `cust_order_items[${idx}]`);
        input.setAttribute('name', newName);
      });
      
      // Reindex elements within this item
      const elementsContainer = item.querySelector('.elements-container');
      if (elementsContainer) {
        const elements = elementsContainer.querySelectorAll('.element-row');
        elements.forEach((elem, elemIdx) => {
          elem.setAttribute('data-element-index', elemIdx);
          elem.querySelectorAll('input').forEach(input => {
            const name = input.getAttribute('name');
            // Replace po_struct_elements[ANY_NUMBER] with po_struct_elements[elemIdx]
            // Pattern: cust_order_items[itemIdx][po_struct_elements][oldIdx][field]
            const newName = name.replace(/cust_order_items\[\d+\]\[po_struct_elements\]\[\d+\]/, `cust_order_items[${idx}][po_struct_elements][${elemIdx}]`);
            input.setAttribute('name', newName);
          });
        });
      }
    });
    itemCounter = items.length;
  }

  // Add new order item
  document.getElementById('add-order-item-btn')?.addEventListener('click', () => {
    const itemDiv = document.createElement('div');
    itemDiv.className = 'card mb-3 order-item';
    itemDiv.setAttribute('data-item-index', itemCounter);
    itemDiv.innerHTML = `
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>Элемент заказа #${itemCounter + 1}</strong>
        <button type="button" class="btn btn-sm btn-danger remove-order-item">Удалить</button>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">EXTERNAL_ID</label>
            <input class="form-control" name="cust_order_items[${itemCounter}][external_id]" value="">
          </div>
          <div class="col-md-2">
            <label class="form-label">ORDER_NUM</label>
            <input class="form-control" type="number" name="cust_order_items[${itemCounter}][order_num]" value="">
          </div>
          <div class="col-md-2">
            <label class="form-label">PO_COMPONENT_ID</label>
            <input class="form-control" type="number" name="cust_order_items[${itemCounter}][po_component_id]" value="">
          </div>
          <div class="col-md-2">
            <label class="form-label">PRODUCT_OFFER_STRUCT_ID</label>
            <input class="form-control" type="number" name="cust_order_items[${itemCounter}][product_offer_struct_id]" value="">
          </div>
          <div class="col-md-2">
            <label class="form-label">SERVICE_COUNT</label>
            <input class="form-control" type="number" name="cust_order_items[${itemCounter}][service_count]" value="">
          </div>
        </div>
        <div class="mt-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <strong>PO_STRUCT_ELEMENTS</strong>
            <button type="button" class="btn btn-sm btn-secondary add-element-btn">Добавить элемент</button>
          </div>
          <div class="elements-container"></div>
        </div>
      </div>
    `;
    container.appendChild(itemDiv);
    itemCounter++;
    attachItemEventListeners(itemDiv);
  });

  // Remove order item
  container.addEventListener('click', (e) => {
    if (e.target.classList.contains('remove-order-item')) {
      e.target.closest('.order-item').remove();
      reindexItems();
    }
  });

  // Add element to an item
  container.addEventListener('click', (e) => {
    const addBtn = e.target.closest('.add-element-btn');
    if (addBtn) {
      e.preventDefault();
      e.stopPropagation();
      const item = addBtn.closest('.order-item');
      if (!item) return;
      const itemIdx = item.getAttribute('data-item-index');
      const elementsContainer = item.querySelector('.elements-container');
      if (!elementsContainer) return;
      const elemCount = elementsContainer.querySelectorAll('.element-row').length;
      
      const elemDiv = document.createElement('div');
      elemDiv.className = 'row g-2 mb-2 element-row';
      elemDiv.setAttribute('data-element-index', elemCount);
      elemDiv.innerHTML = `
        <div class="col-md-4">
          <label class="form-label">PO_STRUCT_ELEMENT_ID</label>
          <input class="form-control" type="number" name="cust_order_items[${itemIdx}][po_struct_elements][${elemCount}][po_struct_element_id]" value="">
        </div>
        <div class="col-md-3">
          <label class="form-label">SERVICE_COUNT</label>
          <input class="form-control" type="number" name="cust_order_items[${itemIdx}][po_struct_elements][${elemCount}][service_count]" value="">
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button type="button" class="btn btn-sm btn-danger remove-element-btn">Удалить элемент</button>
        </div>
      `;
      elementsContainer.appendChild(elemDiv);
      // Reindex elements after adding
      reindexItems();
    }
  });

  // Remove element from an item
  container.addEventListener('click', (e) => {
    const removeBtn = e.target.closest('.remove-element-btn');
    if (removeBtn) {
      e.preventDefault();
      e.stopPropagation();
      const elementRow = removeBtn.closest('.element-row');
      if (elementRow) {
        elementRow.remove();
        reindexItems();
      }
    }
  });

  function attachItemEventListeners(item) {
    // Event listeners are attached via container delegation, so this is just for future use
  }
</script>
{% endblock %}
