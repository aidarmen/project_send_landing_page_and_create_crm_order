name: Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é –∏–∑ GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: Add server to known hosts
      run: |
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
    
    - name: Deploy to server
      env:
        SERVER_USER: ${{ secrets.SERVER_USER }}
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SERVER_PATH: ${{ secrets.SERVER_PATH }}
      run: |
        echo "üöÄ Starting deployment..."
        echo "üì° Server: ${SERVER_USER}@${SERVER_HOST}"
        echo "üìÅ Path: ${SERVER_PATH}"
        
        # –ö–æ–ø–∏—Ä—É–µ–º —Å–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        scp deploy.sh ${SERVER_USER}@${SERVER_HOST}:/tmp/deploy.sh
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º –¥–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        ssh ${SERVER_USER}@${SERVER_HOST} << ENDSSH
          set -e
          export SERVER_PATH="${SERVER_PATH}"
          
          echo "üìÅ Project directory: $SERVER_PATH"
          cd "$SERVER_PATH"
          
          # 1. –ë—ç–∫–∞–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
          echo ""
          echo "1. Creating database backup..."
          if [ -f "./data/app.db" ]; then
            BACKUP_DIR="./backups"
            mkdir -p "$BACKUP_DIR"
            TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
            BACKUP_FILE="$BACKUP_DIR/app.db.backup.$TIMESTAMP"
            cp ./data/app.db "$BACKUP_FILE"
            echo "   ‚úÖ Backup created: $BACKUP_FILE"
          fi
          
          # 2. –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
          echo ""
          echo "2. Pulling latest changes from GitHub..."
          git fetch origin
          git reset --hard origin/main
          
          # 3. –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞
          echo ""
          echo "3. Building Docker image..."
          sudo docker compose build web
          
          # 4. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
          echo ""
          echo "4. Restarting containers..."
          sudo docker compose up -d web
          
          # 5. –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞
          echo ""
          echo "5. Waiting for container to be healthy..."
          sleep 15
          
          # 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
          echo ""
          echo "6. Checking container status..."
          sudo docker compose ps
          
          # 7. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
          echo ""
          echo "7. Verifying database..."
          if [ -f "./data/app.db" ]; then
            DB_SIZE=$(stat -c %s ./data/app.db 2>/dev/null || stat -f %z ./data/app.db 2>/dev/null)
            if [ "$DB_SIZE" -gt 0 ]; then
              echo "   ‚úÖ Database exists and has data ($(du -h ./data/app.db | cut -f1))"
            fi
          fi
          
          # 8. –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏
          echo ""
          echo "8. Recent logs:"
          sudo docker compose logs --tail=20 web
          
          echo ""
          echo "‚úÖ Deployment completed successfully!"
ENDSSH
    
    - name: Deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "‚úÖ Deployment successful!"
        else
          echo "‚ùå Deployment failed!"
          exit 1
        fi

